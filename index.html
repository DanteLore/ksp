<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

    <script lang="JavaScript">

        $(document).ready(function() {
            $('#theFile').on("change", function() {
                if ($('#theFile').val() && $('#theFile') != '') {
                    $('#submitButton').removeAttr("disabled")
                } else {
                    $('#submitButton').attr("disabled", "disabled");
                }
            });
        });

        const lambda_url = "https://rb8fe5adqd.execute-api.eu-west-1.amazonaws.com/prod";
        var key = ''

        function handleError(xhr, textStatus, errorThrown) {
            alert(xhr.responseText + ' ' + textStatus);
        }

        function displayResults(result) {
            if(result.status == 'Success' && result.download_link) {
                html = '<a href="' + result.download_link + '">Download Repaired File</a><br/>';
                $("#results").append(html)
            }
            else if(result.status == 'Failed' && result.error_message) {
                html = "<p>Failed with the following error message: <em>" + result.error_message + "</em></p>";
                $("#results").append(html)
            }
            else {
                html = "<p>It didn't work and I don't know why!  No error code returned.  Sorry!</p>";
                $("#results").append(html)
            }

            $("#theFile").val('');
            $('#theFile').removeAttr("disabled");
            $('#SubmitButton').attr("disabled", "disabled");
        }

        function doConversion(result) {
            html = '<p>Beginning conversion on input ref:' + key + '</p>';
            $("#results").append(html)

            let postData = {s3_key: key}

            $.post(url=lambda_url, data=postData)
               .done(displayResults)
               .fail(handleError);
        }

        function doUpload(result) {
            let url = result.upload_link;
            key = result.s3_key;

            html = '<p>Uploading file...</p>';
            $("#results").append(html)

            var theFile = $('#theFile').get()[0].files[0];

            $.ajax({
                url: url,
                type: 'PUT',
                data: theFile,
                contentType: 'binary/octet-stream',
                processData: false,
                success: doConversion,
                error: handleError
            });
        }

        function submitToAPI(e) {
            html = '<p>Getting upload link...</p>';
            $("#results").append(html)

            e.preventDefault();

            $('#submitButton').attr("disabled", "disabled");
            $('#theFile').attr("disabled", "disabled");
            $('#results').empty()

            // https://docs.aws.amazon.com/AmazonS3/latest/userguide/PresignedUrlUploadObject.html
            // Call a function to get a pre-signed PUT URL
            // Post the file to that URL
            // Then call the lambda below to process the file and get the temp URL for the output file
            $.post(url=lambda_url)
               .done(doUpload)
               .fail(handleError);
         }
    </script>
</head>

<body>

<h1>Unofficial KSP Docking Port Fixer</h1>

<form id="ksp-fix-form" method="post">
    <p>Select your <a href="https://wiki.kerbalspaceprogram.com/wiki/Root_directory" target="_new">KSP save file:</a></p>
    <input type="file" id="theFile">
    <button type="button" onClick="submitToAPI(event)" id="submitButton" disabled="true">Fix Dodgy Docking Ports</button>
</form>

<span id="results"></span>

</body>
</html>